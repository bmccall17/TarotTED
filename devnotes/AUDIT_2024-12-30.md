# TarotTED Application Audit

**Date:** December 30, 2025
**Version:** v1.0.6 (Production)
**Note:** package.json shows "0.1.0" but git tags confirm v1.0.6

---

## Executive Summary

TarotTED is a lookup instrument mapping 78 Tarot cards to TED talks. The application is built on a modern tech stack (Next.js 15, React 19, TypeScript, Drizzle ORM, Supabase) with a clean architecture. The core functionality is complete and working, with a full admin portal for content management.

**Overall Health Score: 7.5/10**

| Area | Score | Assessment |
|------|-------|------------|
| Architecture | 8/10 | Clean separation, modern patterns |
| Frontend/UX | 6/10 | Functional but needs visual polish |
| Backend/API | 7/10 | Complete but needs rate limiting, validation |
| Data Quality | 7/10 | Good schema, some technical debt |
| Security | 6/10 | Basic protection, needs hardening |
| DevOps | 6/10 | Relies on Vercel, limited observability |

---

## 1. Technology Stack

### Core
- **Next.js 15.1.0** - App Router, Server/Client components
- **React 19.0.0** - Latest with concurrent rendering
- **TypeScript 5** - Strict mode enabled
- **Node.js 22** (implied from @types/node)

### Database & Storage
- **PostgreSQL** via Supabase (cloud-hosted)
- **Drizzle ORM 0.45.0** - TypeScript-first ORM
- **Supabase Storage** - Card images, talk thumbnails (2 buckets)
- **3 migrations** applied to schema

### Styling
- **Tailwind CSS 3.4.1** - Utility-first
- **Lucide React 0.556.0** - Icon library
- **Dark theme** with indigo/purple gradient aesthetic

### Analytics
- **Vercel Analytics 1.6.1**
- **Vercel Speed Insights 1.3.1**

---

## 2. Application Architecture

### Route Structure

```
Public Routes:
├── /                    Landing page (draw card, search, featured theme)
├── /cards               All 78 cards grid with filtering
├── /cards/[slug]        Card detail with talk mappings
├── /talks               Talk list with search/duration filters
├── /talks/[slug]        Talk detail with card mappings
├── /themes              Theme collections grid
├── /themes/[slug]       Theme detail with cards/talks
└── /search              Omnibox search with faceted filters

Admin Routes (token-protected):
├── /admin               Dashboard with stats & health
├── /admin/cards         Card content management
├── /admin/talks         Talk CRUD (create/edit/soft-delete)
├── /admin/talks/new     New talk form
├── /admin/mappings      Card-talk relationship editor
├── /admin/validation    Data quality dashboard with fix actions
└── /admin/login         Token authentication
```

### Database Schema

| Table | Purpose | Records |
|-------|---------|---------|
| cards | 78 Tarot cards with meanings | 78 (fixed) |
| talks | TED/YouTube videos | Variable |
| card_talk_mappings | Curatorial layer (the core value) | Variable |
| themes | Curated collections | Variable |
| card_themes | Card-theme join | Variable |
| talk_themes | Talk-theme join | Variable |

### Component Organization (~36 components, ~7,200 LOC)

```
components/
├── admin/          # Admin-only (forms, lists, validation modals)
├── cards/          # Card presentation (grid, detail, list item)
├── talks/          # Talk presentation (grid, list item)
├── search/         # Search filters
├── layout/         # BottomNav (mobile navigation)
├── analytics/      # Vercel analytics provider
└── ui/             # Generic UI (Badge)
```

---

## 3. Lingering Issues & Technical Debt

### High Priority

1. **Landing Page Needs Facelift** (UX Score: 5/10)
   - Missing hero visual/animation
   - No featured cards preview
   - Limited branding personality
   - No social proof or engagement hooks
   - Location: `app/page.tsx`

2. **Sidebar Navigation Bug on Edit Talk Page** (Known Edge Case)
   - `router.push()` and `<Link>` components fail silently
   - Workaround: Cancel button uses `window.location.href`
   - Root cause: Next.js router context corruption (unsolved)
   - Location: `components/admin/talks/TalkForm.tsx`

3. **Rate Limiting is In-Memory Only**
   - Resets on server restart
   - Doesn't work across multiple instances
   - Location: `lib/utils/rate-limit.ts`

4. **Static Admin Token**
   - Single token in environment variable
   - No expiration, rotation, or user accounts
   - Location: `middleware.ts`

### Medium Priority

5. **JSON Stored as Text in Database**
   - `keywords`, `journalingPrompts` are JSON strings, not JSONB
   - Can't use PostgreSQL JSON operators
   - Location: `lib/db/schema.ts`

6. **Missing Database Indexes**
   - No index on `(cardId, isPrimary)` in mappings
   - No index on `category` in themes

7. **N+1 Query Patterns**
   - `getAllTalksForAdmin()` aggregates mappings per talk
   - Theme queries do separate COUNT per theme
   - Location: `lib/db/queries/admin-talks.ts`

8. **No Composite Unique Constraint on Join Tables**
   - `card_themes` and `talk_themes` allow duplicate assignments

9. **Soft Deletes Only on Talks**
   - Cards, mappings, themes use permanent delete
   - Inconsistent data governance

### Low Priority

10. **Unused Dependency**: `@vercel/postgres` (app uses Supabase)
11. **Scripts Not Exposed**: 23+ utility scripts run manually with `tsx`
12. **Audit Logging**: Console only, not persisted
13. **Theme Management**: Not implemented in admin UI (uses scripts)

---

## 4. Security Assessment

### Current Protections
- Middleware protects `/admin/*` and `/api/admin/*`
- Token validation via cookie or Authorization header
- Security headers: X-Frame-Options, X-Content-Type-Options, XSS protection
- Supabase service role key server-only

### Missing Security Measures
- No Content-Security-Policy header
- No HSTS (HTTP Strict-Transport-Security)
- No CSRF protection beyond Next.js defaults
- No input sanitization middleware
- No request logging/monitoring

---

## 5. API Coverage

### Admin APIs (22+ endpoints)
- **Talks**: Full CRUD + soft-delete + restore + hard-delete + metadata fetch
- **Cards**: Read + update (no create/delete - fixed corpus)
- **Mappings**: Full CRUD + set-primary
- **Validation**: Get issues + fix actions (9 issue categories)

### Public APIs
- `GET /api/search` - Multi-entity search with facets (max 20 results per type)
- `GET /api/random-card` - Random card slug for "Draw" feature

### Missing
- No pagination
- No batch operations
- No health check endpoint
- No GraphQL layer

---

## 6. Data Quality Dashboard

The validation system tracks 9 issue categories:

| Category | Type | Description |
|----------|------|-------------|
| Duplicate YouTube IDs | Critical | Same video on multiple talks |
| Missing Thumbnails | Important | Null or empty thumbnail URLs |
| External Thumbnails | Important | HTTP URLs (not Supabase) |
| Short Descriptions | Important | Less than 50 characters |
| Only YouTube URL | Info | No TED.com URL |
| Cards Without Primary | Mapping | No primary talk assigned |
| Unmapped Talks | Mapping | Talks with zero mappings |
| Soft-Deleted Talks | Info | Available for restore |

---

## 7. Landing Page Analysis

### Current State (`app/page.tsx`)
1. Sparkles icon + "Tarot of TED" title
2. Search bar (routes to /search)
3. "Draw a Card & Talk" button (random card)
4. Browse Cards / Browse Talks buttons
5. Featured Theme showcase box
6. "How this works" collapsible accordion

### Issues
- No visual hero (just text)
- No card previews or talk thumbnails
- Featured theme is text-heavy
- Key info hidden in accordion
- No social proof (card count, talk count, testimonials)

---

## 8. Creative Directions for Landing Page

### Option A: Card-Centric Hero
- Animated tarot card fan or spread visualization
- Hover reveals card details
- "Draw Your Card" as primary CTA with flip animation
- Featured cards carousel below hero

### Option B: Video-Forward Hero
- Background video montage of TED moments
- Mystical gradient overlay
- Talk thumbnails in masonry grid below
- "Discover Wisdom" tagline

### Option C: Interactive Experience
- 3-card spread animation on load
- Each card flips to reveal a talk
- Personalized "Your Reading" feel
- Immediate engagement before scroll

### General Enhancements
1. **Typography** - Serif for tarot titles, sans-serif for content
2. **Card hover effects** - Subtle glow, elevation on hover
3. **Theme colors** - Each theme gets unique accent color
4. **Micro-interactions** - Button feedback, smooth transitions
5. **Loading states** - Skeleton screens, subtle animations

---

## 9. Recommended Next Steps

### Immediate
- [ ] Redesign landing page with visual hero
- [ ] Add skeleton loading states
- [ ] Implement error boundaries
- [ ] Add health check endpoint

### Short-term
- [ ] Add database indexes for common queries
- [ ] Implement Redis-based rate limiting
- [ ] Add CSP header
- [ ] Convert JSON strings to JSONB columns

### Medium-term
- [ ] Implement theme management in admin
- [ ] Add API pagination
- [ ] Implement structured logging
- [ ] Accessibility audit and fixes

### Long-term
- [ ] Full-text search (PostgreSQL FTS)
- [ ] Reading/spread builder feature
- [ ] Social sharing functionality
- [ ] User accounts and favorites

---

## 10. Key Files Reference

### Configuration
- `next.config.ts` - Security headers, image optimization
- `drizzle.config.ts` - Database connection
- `middleware.ts` - Auth protection

### Database
- `lib/db/schema.ts` - Table definitions
- `lib/db/queries/*` - Query functions (8 modules)

### Core Components (needs attention)
- `app/page.tsx` - Landing page (facelift needed)
- `components/admin/talks/TalkForm.tsx` - Router bug workaround
- `components/layout/BottomNav.tsx` - Mobile navigation
- `lib/utils/rate-limit.ts` - In-memory limitation

### Storage
- `lib/supabase/storage.ts` - File operations
- `lib/utils/thumbnails.ts` - Thumbnail URL handling

---

## File Statistics

| Metric | Count |
|--------|-------|
| TypeScript/TSX files | ~127 |
| Components | ~36 |
| API routes | 22+ |
| Database tables | 6 |
| Migrations | 3 |
| Utility scripts | 23+ |
