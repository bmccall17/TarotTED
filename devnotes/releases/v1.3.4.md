# v1.3.4 - Enhanced Card Social Share Images with Talk Integration ðŸŽ´

**Released:** January 29, 2026

## Summary

Major upgrade to card social share images. Each card's OG image now showcases the primary mapped TED talk alongside the card, making social shares more informative and engaging. Features OpenDyslexic font, dynamic starfields, and platform-safe layout. Includes critical bug fixes that resolved images not appearing on Twitter/BlueSky.

## Features

### Layout A3 Design
- **Brand**: TarotTALKS logo in top-left corner (baseline-aligned)
- **Talk Section**: Primary mapped TED talk at bottom-left
  - Large thumbnail (300x150)
  - Talk title (truncated at 55 chars)
  - Speaker name
- **Card Info**: Right-justified, vertically centered
  - Card name (uppercase, 48px)
  - Full summary text
  - Up to 4 keyword pills
- **Card Image**: Full artwork on right side (260x514)

### OpenDyslexic Font
- Custom font loaded for all text
- Improves readability and accessibility
- Graceful fallback to system fonts if loading fails
- Fonts fetched from `/fonts/OpenDyslexic-Regular.woff` and `OpenDyslexic-Bold.woff`

### Dynamic Starfields
- Time-seeded sparkle pattern using `Date.now()`
- **Every image load produces a unique starfield** (not deterministic per card)
- 12-15 stars per image with varied sizes (3-5px) and opacity (0.4-0.9)
- Lightweight inline generation (no separate component)

### Platform Safe Buffer
- 80px bottom padding to avoid Twitter/X overlay
- Talk info positioned above the overlay zone
- Reduced thumbnail height (150px) to fit within safe area

## Bug Fixes

### Critical: Metadata Inheritance Fix
- **Issue**: Social share images were not appearing on Twitter/BlueSky
- **Root cause**: Child route metadata was inheriting parent's static OG images instead of using dynamic routes
- **Fix**: Added explicit `images` property in `generateMetadata()` pointing to dynamic image routes
- **File**: `app/cards/[slug]/page.tsx`

```typescript
// Before (broken): images inherited from parent layout
openGraph: {
  title: `${card.name} - TarotTALKS`,
  // No images property - inherited static homepage image
}

// After (fixed): explicit dynamic image URLs
openGraph: {
  title: `${card.name} - TarotTALKS`,
  images: [{
    url: `https://tarottalks.app/cards/${card.slug}/opengraph-image`,
    width: 1200,
    height: 630,
  }],
}
```

### Variable Shadowing Fix
- **Issue**: `Sparkle` component prop `size` shadowed the exported `size` constant (image dimensions)
- **Fix**: Renamed to `starSize` then simplified to inline object properties

### Satori Compatibility
- Simplified CSS to ensure compatibility with Satori (next/og renderer)
- Removed complex box-shadows that could cause rendering issues
- Inlined sparkle generation instead of separate component

## Technical Implementation

### Files Modified
- `app/cards/[slug]/opengraph-image.tsx` - OpenGraph image generation
- `app/cards/[slug]/twitter-image.tsx` - Twitter/X and Bluesky images
- `app/cards/[slug]/page.tsx` - Fixed metadata to use dynamic images

### Files Added
- `app/preview/card-share/page.tsx` - Debug preview page for testing OG images

### Key Architecture

**Image Generation Flow:**
1. Social platform requests `/cards/[slug]/opengraph-image`
2. Next.js invokes `opengraph-image.tsx`
3. `loadFonts()` and `getCardWithMappings()` run in parallel
4. Sparkles generated with `Date.now()` seed
5. `ImageResponse` renders JSX to PNG (1200x630)

**Font Loading:**
```typescript
async function loadFonts() {
  const [regularRes, boldRes] = await Promise.all([
    fetch('https://tarottalks.app/fonts/OpenDyslexic-Regular.woff'),
    fetch('https://tarottalks.app/fonts/OpenDyslexic-Bold.woff'),
  ]);
  return { regular: await regularRes.arrayBuffer(), bold: await boldRes.arrayBuffer() };
}
```

**Sparkle Generation:**
```typescript
const sparkles = [];
let seed = Date.now();
const random = () => {
  seed = (seed * 9301 + 49297) % 233280;
  return seed / 233280;
};
```

## Testing

### Preview Page
Visit `/preview/card-share` to test OG image generation:
- Shows multiple cards with both OpenGraph and Twitter images
- Refresh button to see new starfield patterns
- Toggle cards on/off for comparison
- Direct URLs displayed for debugging

### Social Platform Testing
1. Share card URLs on Twitter/X - verify image appears
2. Share on Bluesky - same branded image with talk
3. Share on Facebook/LinkedIn - OG image shows talk integration
4. Use Twitter Card Validator to force cache refresh

## Before & After

**Before (v1.3.3)**:
- Images not appearing on social platforms (metadata bug)
- Static sparkle positions
- System fonts only

**After (v1.3.4)**:
- Images properly displayed on all platforms
- Dynamic sparkle pattern per load
- OpenDyslexic font with fallback
- Primary talk integration
- Platform-safe layout

## Notes

- Cards without a primary talk mapping will show layout without talk section
- Talk thumbnails fetched from Supabase Storage or YouTube
- Images generated on-demand at runtime (not cached by Next.js)
- Font loading has graceful fallback to system fonts
- Social platforms cache images aggressively - use validators to refresh
