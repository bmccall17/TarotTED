## v1.1.4 - Ritual State Preservation ğŸ”®
**Release Date:** January 4, 2026
**Status:** Production Ready

### Overview

Implements state preservation for the ritual page using sessionStorage, allowing users to navigate to card or talk details and return to their ritual with the same cards and reveal state intact. Smart back buttons automatically return users to the ritual context when available.

### âœ¨ New Features

#### **Ritual State Persistence**
- Ritual state (3 card slugs, reveal indices, layout mode) automatically saved to sessionStorage
- State restored when navigating back from card/talk detail pages
- 30-minute expiry prevents stale rituals
- Graceful fallback to random cards if:
  - sessionStorage unavailable (private browsing)
  - Saved cards no longer exist in database
  - State expired (>30 minutes)

#### **Smart Back Buttons**
- Context-aware back navigation on card and talk detail pages
- Returns to ritual page (/) if there's saved ritual state
- Returns to collection pages (/cards or /talks) otherwise
- Supports both icon-only (header) and text variants (footer)

#### **API Enhancement**
- `/api/ritual-cards` now supports fetching specific cards by slugs
- Query parameter: `?slugs=card-slug-1,card-slug-2,card-slug-3`
- Maintains order of requested slugs
- Falls back to random cards if any requested cards not found

### ğŸ“ New Files Created

```
lib/hooks/
â””â”€â”€ useRitualState.ts             # State persistence hook with 30-min expiry

components/ui/
â””â”€â”€ SmartBackButton.tsx           # Context-aware back button component
```

### ğŸ”§ Modified Files

| File | Changes |
|------|---------|
| `app/api/ritual-cards/route.ts` | Added support for fetching cards by slugs via query parameter |
| `components/ritual/CardCascade.tsx` | State save/restore logic, checks for saved state on mount |
| `app/cards/[slug]/page.tsx` | Header and footer back buttons replaced with SmartBackButton |
| `app/talks/[slug]/page.tsx` | Header and footer back buttons replaced with SmartBackButton |

### ğŸ¯ User Flow

1. User draws 3 cards on ritual page â†’ State saved to sessionStorage
2. User reveals cards â†’ State updated with reveal indices and layout mode
3. User clicks on a card or talk â†’ Navigates to detail page
4. User clicks back button â†’ Returns to ritual page with same 3 cards in same reveal state
5. After 30 minutes â†’ State expires, fresh random cards drawn on next visit
6. User clicks "Draw New Cards" â†’ State cleared, new random cards drawn

### ğŸ”§ Technical Details

**State Structure:**
```typescript
{
  cardSlugs: string[];           // 3 card slugs
  revealedIndices: number[];     // Which cards are revealed (0-2)
  layoutMode: LayoutMode;        // 'stacked' | 'spread-2' | 'spread-3'
  timestamp: number;             // For 30-minute expiry
}
```

**Storage Key:** `tarotted-ritual-state`
**Expiry:** 30 minutes (1,800,000 ms)
**Storage Type:** sessionStorage (cleared when browser tab closes)

### ğŸ“ Implementation Notes

This feature was originally planned for v1.2.0 but deferred during the mobile QOL improvements release. Full implementation details were documented in `/devnotes/NEXT-STEPS_landingpagecardimprovements.md`.
